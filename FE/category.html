<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookly - Sách</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="luxury.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Cormorant+Garamond:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- SVG Icons -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="user" viewBox="0 0 24 24">
      <path fill="currentColor" fill-rule="evenodd" d="M12 1.25a4.75 4.75 0 1 0 0 9.5a4.75 4.75 0 0 0 0-9.5M8.75 6a3.25 3.25 0 1 1 6.5 0a3.25 3.25 0 0 1-6.5 0M12 12.25c-2.313 0-4.445.526-6.024 1.414C4.42 14.54 3.25 15.866 3.25 17.5v.102c-.001 1.162-.002 2.62 1.277 3.662c.629.512 1.51.877 2.7 1.117c1.192.242 2.747.369 4.773.369s3.58-.127 4.774-.369c1.19-.24 2.07-.605 2.7-1.117c1.279-1.042 1.277-2.5 1.276-3.662V17.5c0-1.634-1.17-2.96-2.725-3.836c-1.58-.888-3.711-1.414-6.025-1.414M4.75 17.5c0-.851.622-1.775 1.961-2.528c1.316-.74 3.184-1.222 5.29-1.222c2.104 0 3.972.482 5.288 1.222c1.34.753 1.961 1.677 1.961 2.528c0 1.308-.04 2.044-.724 2.6c-.37.302-.99.597-2.05.811c-1.057.214-2.502.339-4.476.339c-1.974 0-3.42-.125-4.476-.339c-1.06-.214-1.68-.509-2.05-.81c-.684-.557-.724-1.293-.724-2.601" clip-rule="evenodd"/>
    </symbol>
    <symbol id="cart" viewBox="0 0 24 24">
      <path fill="currentColor" fill-rule="evenodd" d="M2.249 2.292a.75.75 0 1 0-.498 1.416l.262.091c.667.235 1.106.39 1.429.549c.303.149.437.27.525.398c.09.132.16.314.2.677c.04.38.041.875.041 1.615V9.76c0 1.453.014 2.5.151 3.3c.146.854.438 1.466.985 2.042c.594.627 1.346.9 2.243 1.026c.858.122 1.948.122 3.293.122h5.406c.742 0 1.366 0 1.87-.062c.537-.065 1.025-.209 1.452-.556c.426-.348.665-.797.837-1.309c.163-.482.289-1.093.439-1.82l.508-2.469l.002-.005l.01-.052c.165-.825.303-1.519.338-2.077c.036-.586-.031-1.164-.413-1.66c-.235-.306-.565-.479-.866-.584a4.617 4.617 0 0 0-1.002-.21c-.687-.076-1.522-.076-2.34-.076H5.667a5.932 5.932 0 0 0-.01-.108c-.054-.497-.17-.95-.453-1.362c-.284-.416-.662-.682-1.102-.899c-.412-.202-.936-.386-1.553-.603zm3.46 4.578h11.38c.856 0 1.61.001 2.205.067c.296.034.517.08.672.134a.56.56 0 0 1 .176.086c.062.082.128.23.102.651c-.027.444-.143 1.036-.321 1.926v.002l-.5 2.42c-.16.783-.27 1.303-.399 1.688c-.123.366-.239.523-.364.625c-.125.102-.303.184-.685.23c-.404.05-.935.051-1.734.051h-5.303c-1.417 0-2.4-.002-3.14-.107c-.716-.101-1.093-.285-1.366-.573c-.32-.338-.493-.668-.595-1.263c-.11-.65-.129-1.558-.129-3.047zM7.5 21.75a2.25 2.25 0 1 1 0-4.5a2.25 2.25 0 0 1 0 4.5m-.75-2.25a.75.75 0 1 0 1.5 0a.75.75 0 0 0-1.5 0m9.75 2.25a2.25 2.25 0 1 1 0-4.5a2.25 2.25 0 0 1 0 4.5m-.75-2.25a.75.75 0 1 0 1.5 0a.75.75 0 0 0-1.5 0" clip-rule="evenodd"/>
    </symbol>
  </svg>

  <!-- Header -->
  <header class="site-header glass-navbar">
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <img src="images/main-logo.png" class="logo" alt="Bookly">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="border-color: var(--luxury-gold);">
          <span class="navbar-toggler-icon" style="background-image: url('data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 30 30\'%3e%3cpath stroke=\'rgba(212, 175, 55, 1)\' stroke-linecap=\'round\' stroke-miterlimit=\'10\' stroke-width=\'2\' d=\'M4 7h22M4 15h22M4 23h22\'/%3e%3c/svg%3e');"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mx-auto align-items-center">
            <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
            <li class="nav-item"><a class="nav-link active cursor-pointer" href="category.html">Sách</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">Về chúng tôi</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Liên hệ</a></li>
          </ul>
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item pe-3 position-relative">
              <a href="cart.html" class="nav-link cursor-pointer">
                <svg class="cart" width="24" height="24"><use xlink:href="#cart"></use></svg>
                <span id="cart-count" class="badge position-absolute top-0 start-100 translate-middle" style="background: var(--luxury-gold); color: var(--luxury-black);">0</span>
              </a>
            </li>
            <li class="nav-item dropdown" style="position: relative;">
              <a href="login.html" id="auth-trigger" class="nav-link cursor-pointer">
                <svg class="user" width="24" height="24"><use xlink:href="#user"></use></svg>
              </a>
              <span id="greet-text" class="nav-link" style="display:none; cursor:pointer;"></span>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Filters and Sort -->
  <section class="padding-large py-4" style="padding-top: 120px;">
    <div class="container">
      <div class="row g-3 mb-4">
        <!-- Filter Buttons -->
        <div class="col-md-12 mb-3">
          <div class="books-filter-bar">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">
              Tất cả danh mục
            </button>
            <button class="filter-btn" data-filter="category" onclick="showCategoryDropdown()">
              Danh mục
            </button>
            <button class="filter-btn" data-filter="author" onclick="showAuthorInput()">
              Tác giả
            </button>
            <button class="filter-btn" data-filter="publisher" onclick="showPublisherInput()">
              Nhà xuất bản
            </button>
            <button class="filter-btn" data-sort="name" onclick="setSort('name')">
              Tên A-Z
            </button>
            <button class="filter-btn" data-sort="price-asc" onclick="setSort('price-asc')">
              Giá tăng dần
            </button>
            <button class="filter-btn" data-sort="price-desc" onclick="setSort('price-desc')">
              Giá giảm dần
            </button>
          </div>
        </div>
        
        <!-- Filter Dropdowns/Inputs (hidden by default) -->
        <div class="col-md-12 mb-3" id="filter-dropdowns" style="display: none;">
          <div id="category-dropdown-wrapper" style="display: none;">
            <select id="filter-category" class="form-select">
              <option value="">-- Chọn danh mục --</option>
            </select>
          </div>
          <div id="author-input-wrapper" style="display: none;">
            <input type="text" id="filter-author" class="form-control" placeholder="Nhập tên tác giả...">
          </div>
          <div id="publisher-input-wrapper" style="display: none;">
            <input type="text" id="filter-publisher" class="form-control" placeholder="Nhập tên nhà xuất bản...">
          </div>
        </div>
      </div>
      <div class="row" id="catalog-grid">
        <!-- Will be populated by JS -->
      </div>
      <div class="d-flex justify-content-center mt-5">
        <nav aria-label="Page navigation">
          <ul class="pagination" id="pagination">
            <!-- Will be populated by JS -->
          </ul>
        </nav>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <div class="row">
        <div class="col-md-4 mb-4">
          <h5>Về Bookly</h5>
          <p>Nhà sách trực tuyến hàng đầu Việt Nam, nơi văn học gặp gỡ sự tinh tế.</p>
        </div>
        <div class="col-md-4 mb-4">
          <h5>Liên hệ</h5>
          <p>Email: info@bookly.vn</p>
          <p>Điện thoại: 1900-xxxx</p>
        </div>
        <div class="col-md-4 mb-4">
          <h5>Theo dõi chúng tôi</h5>
          <p>
            <a href="#" class="text-luxury-gold me-3">Facebook</a> | 
            <a href="#" class="text-luxury-gold me-3">Instagram</a> | 
            <a href="#" class="text-luxury-gold">Twitter</a>
          </p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    let currentPage = 1;
    let totalPages = 1;
    let allBooks = [];
    let filterState = {
      filterType: 'all', // all, category, author, publisher
      filterValue: null,
      sortBy: 'name' // name, price-asc, price-desc
    };

    const loadBooks = async (page = 1) => {
      try {
        const categoryId = new URLSearchParams(window.location.search).get("category");
        
        let path;
        if (categoryId) {
          path = `/api/categories/${categoryId}/books`;
        } else {
          path = `/api/books?page=${page}&pageSize=100`; // Load more to filter client-side
        }

        const response = await window.apiRequest(path);
        let books = [];
        if (Array.isArray(response)) {
          books = response;
          totalPages = 1;
        } else if (response?.data && Array.isArray(response.data)) {
          books = response.data;
          totalPages = response.totalPages || 1;
        } else {
          books = [];
        }
        
        // Store all books for filtering
        allBooks = books;
        
        // Apply filters
        let filteredBooks = [...allBooks];
        
        // Filter by category
        if (filterState.filterType === 'category' && filterState.filterValue) {
          filteredBooks = filteredBooks.filter(book => 
            (book.categoryId || book.CategoryId) === filterState.filterValue
          );
        }
        
        // Filter by author
        if (filterState.filterType === 'author' && filterState.filterValue) {
          const authorName = filterState.filterValue.toLowerCase();
          filteredBooks = filteredBooks.filter(book => {
            const bookAuthor = (book.author?.authorName || book.Author?.AuthorName || '').toLowerCase();
            return bookAuthor.includes(authorName);
          });
        }
        
        // Filter by publisher
        if (filterState.filterType === 'publisher' && filterState.filterValue) {
          const publisherName = filterState.filterValue.toLowerCase();
          filteredBooks = filteredBooks.filter(book => {
            const bookPublisher = (book.publisher?.publisherName || book.Publisher?.PublisherName || '').toLowerCase();
            return bookPublisher.includes(publisherName);
          });
        }
        
        // Apply sort
        switch(filterState.sortBy) {
          case 'name':
            filteredBooks.sort((a, b) => {
              const nameA = (a.title || a.Title || '').toLowerCase();
              const nameB = (b.title || b.Title || '').toLowerCase();
              return nameA.localeCompare(nameB, 'vi');
            });
            break;
          case 'price-asc':
            filteredBooks.sort((a, b) => {
              const priceA = a.price || a.Price || 0;
              const priceB = b.price || b.Price || 0;
              return priceA - priceB;
            });
            break;
          case 'price-desc':
            filteredBooks.sort((a, b) => {
              const priceA = a.price || a.Price || 0;
              const priceB = b.price || b.Price || 0;
              return priceB - priceA;
            });
            break;
        }
        
        // Pagination
        const pageSize = 12;
        totalPages = Math.ceil(filteredBooks.length / pageSize);
        const startIndex = (page - 1) * pageSize;
        const paginatedBooks = filteredBooks.slice(startIndex, startIndex + pageSize);
        currentPage = page;

        window.renderGrid("catalog-grid", paginatedBooks);
        
        // Pagination
        const pagination = document.getElementById("pagination");
        if (pagination && totalPages > 1) {
          let html = "";
          
          // Previous button
          if (currentPage > 1) {
            html += `<li class="page-item"><a class="page-link cursor-pointer" href="#" onclick="loadBooks(${currentPage - 1}); return false;" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>`;
          } else {
            html += `<li class="page-item disabled"><span class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></span></li>`;
          }
          
          // Page numbers - show max 7 pages
          const maxPages = 7;
          let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
          let endPage = Math.min(totalPages, startPage + maxPages - 1);
          
          if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
          }
          
          if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link cursor-pointer" href="#" onclick="loadBooks(1); return false;">1</a></li>`;
            if (startPage > 2) {
              html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
          }
          
          for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link cursor-pointer" href="#" onclick="loadBooks(${i}); return false;">${i}</a></li>`;
          }
          
          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link cursor-pointer" href="#" onclick="loadBooks(${totalPages}); return false;">${totalPages}</a></li>`;
          }
          
          // Next button
          if (currentPage < totalPages) {
            html += `<li class="page-item"><a class="page-link cursor-pointer" href="#" onclick="loadBooks(${currentPage + 1}); return false;" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>`;
          } else {
            html += `<li class="page-item disabled"><span class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></span></li>`;
          }
          
          pagination.innerHTML = html;
        } else if (pagination) {
          pagination.innerHTML = "";
        }
      } catch (err) {
        console.error("Load books failed:", err);
      }
    };

    // Load categories
    (async () => {
      try {
        const categories = await window.apiRequest("/api/categories");
        const catList = Array.isArray(categories) ? categories : [];
        const select = document.getElementById("filter-category");
        if (select) {
          catList.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.categoryId || cat.CategoryId;
            option.textContent = cat.categoryName || cat.CategoryName;
            select.appendChild(option);
          });
        }
      } catch (err) {
        console.error("Load categories failed:", err);
      }
    })();

    // Filter functions
    function setFilter(filterType) {
      filterState.filterType = filterType;
      filterState.filterValue = null;
      
      // Update active button
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeBtn = document.querySelector(`.filter-btn[data-filter="${filterType}"]`);
      if (activeBtn) activeBtn.classList.add('active');
      
      // Hide dropdowns
      const dropdowns = document.getElementById('filter-dropdowns');
      if (dropdowns) {
        dropdowns.style.display = 'none';
        document.getElementById('category-dropdown-wrapper').style.display = 'none';
        document.getElementById('author-input-wrapper').style.display = 'none';
        document.getElementById('publisher-input-wrapper').style.display = 'none';
      }
      
      loadBooks(1);
    }

    function setSort(sortBy) {
      filterState.sortBy = sortBy;
      
      // Update active button
      document.querySelectorAll('.filter-btn[data-sort]').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeBtn = document.querySelector(`.filter-btn[data-sort="${sortBy}"]`);
      if (activeBtn) activeBtn.classList.add('active');
      
      loadBooks(1);
    }

    function showCategoryDropdown() {
      const dropdowns = document.getElementById('filter-dropdowns');
      if (!dropdowns) return;
      dropdowns.style.display = 'block';
      document.getElementById('category-dropdown-wrapper').style.display = 'block';
      document.getElementById('author-input-wrapper').style.display = 'none';
      document.getElementById('publisher-input-wrapper').style.display = 'none';
      
      // Update active button
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.classList.remove('active');
      });
      const categoryBtn = document.querySelector('.filter-btn[data-filter="category"]');
      if (categoryBtn) categoryBtn.classList.add('active');
    }

    function showAuthorInput() {
      const dropdowns = document.getElementById('filter-dropdowns');
      if (!dropdowns) return;
      dropdowns.style.display = 'block';
      document.getElementById('category-dropdown-wrapper').style.display = 'none';
      document.getElementById('author-input-wrapper').style.display = 'block';
      document.getElementById('publisher-input-wrapper').style.display = 'none';
      
      // Update active button
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.classList.remove('active');
      });
      const authorBtn = document.querySelector('.filter-btn[data-filter="author"]');
      if (authorBtn) authorBtn.classList.add('active');
    }

    function showPublisherInput() {
      const dropdowns = document.getElementById('filter-dropdowns');
      if (!dropdowns) return;
      dropdowns.style.display = 'block';
      document.getElementById('category-dropdown-wrapper').style.display = 'none';
      document.getElementById('author-input-wrapper').style.display = 'none';
      document.getElementById('publisher-input-wrapper').style.display = 'block';
      
      // Update active button
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.classList.remove('active');
      });
      const publisherBtn = document.querySelector('.filter-btn[data-filter="publisher"]');
      if (publisherBtn) publisherBtn.classList.add('active');
    }

    // Event listeners
    document.getElementById("filter-category")?.addEventListener("change", (e) => {
      filterState.filterType = 'category';
      filterState.filterValue = e.target.value ? parseInt(e.target.value) : null;
      loadBooks(1);
    });
    
    document.getElementById("filter-author")?.addEventListener("input", (e) => {
      filterState.filterType = 'author';
      filterState.filterValue = e.target.value.trim();
      loadBooks(1);
    });
    
    document.getElementById("filter-publisher")?.addEventListener("input", (e) => {
      filterState.filterType = 'publisher';
      filterState.filterValue = e.target.value.trim();
      loadBooks(1);
    });

    // Initial load
    loadBooks(1);
  </script>
</body>
</html>

